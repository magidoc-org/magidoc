# GraphQL Query Generator

:::tags
standalone, plugin, node, browser
:::

The GraphQL Query Generator plugin does exactly as its name suggests: it automatically builds GraphQL queries, variables and responses from a root query type.

Generating GraphQL queries requires complex logic that is abstracted by this library. It supports parameter generation, duplicate names, union types and much more.

## Example

Here is a sample query generated by the plugin.

**Query**

```graphql
query getPerson($delay: Int, $delay2: Int) {
  person {
    name
    age(delay: $delay)
    friends {
      name
      age(delay: $delay2)
    }
  }
}
```

**Variables**

```json
{
  "delay": 42,
  "delay2": 42
}
```

**Response**

```javascript
{
  "person": {
    "name": "A name",
    "age": 36,
    "friends": [
      {
        "name": "A name",
        "age": 36
      }
    ]
  }
}
```

## Install

This plugin requires [GraphQL.js](https://www.npmjs.com/package/graphql) as a peer dependency.

```shell
pnpm install -D @magidoc/plugin-query-generator graphql
```

## Usage

Here is a sample usage with TypeScript that would generate the [above query](#example).

```typescript
import {
  generateGraphQLQuery,
  NullGenerationStrategy,
  QueryType,
} from '@magidoc/plugin-query-generator'
import { buildClientSchema, type IntrospectionQuery } from 'graphql'
import schemaJson from '_schema.json'

// Use GraphQL.js to build the schema
const schema = buildClientSchema(schemaJson as unknown as IntrospectionQuery)
const personField = schema.getQueryType()?.getFields()['person']!!

const context = {
  queryName: 'getPerson',
  queryType: QueryType.QUERY,
  maxDepth: 3,
  nullGenerationStrategy: NullGenerationStrategy.NEVER_NULL,
  factories: {},
}

// Generate a query with variables
const query = await generateGraphQLQuery(personField, context)
// Generates a sample response
const response = generateGraphQLResponse(personField, context)

console.log(query)
console.log(response)
```

## Factories

Factories are the most important part of the configuration. It allows customization of how the plugin generates the random values used as [query variables](https://graphql.org/learn/queries/#variables). The plugin offers many [default factories](https://github.com/pelletier197/magidoc/blob/main/packages/plugins/query-generator/src/generator/defaultFactories.ts). Each of these factories can be overwritten and custom ones can be added.

Factories can be used to provide custom generators for [scalar types](https://graphql.org/learn/schema/#scalar-types) and [input values](https://graphql.org/learn/schema/#input-types).

### Custom scalar types

Many GraphQL APIs implement [custom scalars](https://www.apollographql.com/docs/apollo-server/schema/custom-scalars/). Since the plugin cannot automatically determine what is backing these scalars, a custom factory is required for them.

For instance, given schema has a scalar named `OddNumber`, representing any odd number.

```graphql
scalar OddNumber
```

The factory below could be provided.

```typescript
const result = await generateGraphQLQuery(field, {
  factories: {
    OddNumber: () => 5,
  },
})
```

### Factory key

The key for the GraphQL factory object uses glob syntax to determine which factory to use. The factories are used in order of specificity, from the most specific to the least specific. Only the most specific factory will be used to generate the value.

Here are examples of factories going from the most specific to the least specific.

```typescript
const result = await generateGraphQLQuery(field, {
  factories: {
    // A specific path in the request in the format `field.path$argument.path`
    oddNumbersField$argument: () => 3,
    // An argument by name. For instance, if the argument `birthDate` was used often in your API
    // You could specify a similar value for all `birthDate` fields.
    argument: () => [3],
    // Other matchers on type name
    '[OddNumber!]!': () => [5],
    '[OddNumber!]': () => [7],
    'OddNumber!': () => 9,
    OddNumber: () => 11,
    '*Number': () => 13,
  },
})
```

#### Type unwrapping

The query generator uses type unwrapping to try to find a factory in all the provided values. This means that you generally don't need to provide a factory for a `[OddNumber!]!`, because a factory `OddNumber` will be used for all possible wrappings of the type: `OddNumber`, `OddNumber!`, `[OddNumber!]` and `[OddNumber!]!`.

### Factory context

Some GraphQL types, like `String`, are used widely within most GraphQL APIs. You may desire to return a different value for these types based on the context where they are used. This can be achieved using the `context` parameter provided in the factory function.

```typescript
import { generateGraphQLQuery, type QueryType } from '@magidoc/plugin-query-generator'

const result = await generateGraphQLQuery(field, {
  factories: {
    String: (context: GraphQLFactoryContext) => {
      switch(context.targetName.toLowerCase()) {
        case: 'email':
          return 'some-email@mycompany.com'
        case: 'policyName'
          return 'Policy Name'
        default: context.defaultFactory ? context.defaultFactory.provide() : 'abc'
      }
    },
  },
})
```

The parameters found in the context object and their description are described below.

<!-- prettier-ignore -->
| Parameter      | Description |
|----------------|-------------|
| targetName     | Either the argument name or the nested field name. |
| defaultValue   | The default value provided in the GraphQL Schema. You may decide to use it by providing a factory that returns the default value if it is non-null. |
| defaultFactory | The default factory that exists for this type. Can be useful if you want to perform custom actions and fallback to the default provider. Note that this factory is always the factory for a scalar value. Thus, if you create a factory for a `[String!]!`, then the default factory will return a String, not an array of strings. You will be required to return an array yourself. This property is only available when overriding the default generators. |
| randomFactory  | The random factory that would be used to generate this object. This can be useful to fallback on a random object. This is only available when generating input values. |
| depth          | The current depth in the field generation. This does not include the depth of the current parameter. |
| path           | Path in the query to the current parameter. |
